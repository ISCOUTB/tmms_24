<div class='tmms-test-container'>
    <div style="text-align: center; margin-bottom: 15px;">
        <img src="{{icon_url}}" alt="TMMS-24 Icon" style="width: 70px; height: 70px; display: block; margin: 0 auto 10px auto;" />
        <h1 class='title_tmms_24_test' style='text-align: center;'>{{test_page_title}}</h1>
    </div>

    <div class='test-instructions'>
        <h2>{{instructions_title}}</h2>
        <p>{{instructions_text}}</p>
        <p>{{instructions_text2}}</p>
    </div>

    <form method='POST' action='{{save_url}}' class='tmms-form' id='tmmsForm'>
        <input type='hidden' name='cid' value='{{courseid}}'>
        <input type='hidden' name='responseid' value='{{responseid}}'>
        <input type='hidden' name='sesskey' value='{{sesskey}}'>

        <div class='demographics-section'>
            <h3>{{demographics_label}}</h3>
            <div class='form-row'>
                <div class='form-group'>
                    <label for='age'>{{age_label}} *</label>
                    <input type='number' id='age' name='age' class='form-control' min='10' max='100' value='{{age_value}}'>
                </div>
                <div class='form-group'>
                    <label for='gender'>{{gender_label}} *</label>
                    <select id='gender' name='gender' class='form-control'>
                        <option value=''>{{select_option_label}}</option>
                        {{#gender_options}}
                        <option value='{{value}}' {{#selected}}selected{{/selected}}>{{label}}</option>
                        {{/gender_options}}
                    </select>
                </div>
            </div>
        </div>

        <div class='questionnaire-section'>
            <h3>{{questionnaire_label}}</h3>
            {{#items}}
            <div class='question-item' data-item='{{number}}' id='question-{{number}}'>
                <div class='question-header'>
                    <span class='question-text'>{{text}}</span>
                </div>
                <div class='likert-scale'>
                    {{#scale_options}}
                    <label class='likert-option'>
                        <input type='radio' name='item{{number}}' value='{{value}}' {{#checked}}checked{{/checked}}>
                        <span class='likert-label'>{{label}}</span>
                    </label>
                    {{/scale_options}}
                </div>
            </div>
            {{/items}}
        </div>

        <div class='navigation-buttons' style='display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;'>
            <div>
                <a href='{{back_url}}' class='btn btn-secondary'>{{back_to_course_label}}</a>
            </div>
            <div id='finishButtonContainer'>
                <button type='submit' class='btn btn-success' id='submitBtn' style='background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); border: none;'>{{submit_test_label}}</button>
            </div>
        </div>
    </form>
</div>

{{#js}}
require(['jquery'], function($) {
    var form = document.getElementById('tmmsForm');
    var responseIdInput = form ? form.querySelector('input[name="responseid"]') : null;
    var sesskeyInput = form ? form.querySelector('input[name="sesskey"]') : null;
    var courseIdInput = form ? form.querySelector('input[name="cid"]') : null;
    
    if (form) {
        var formAttempted = false;
        var autosaveTimer = null;
        var pendingAutosave = {};
        
        var radios = form.querySelectorAll('input[type="radio"]');
        radios.forEach(function(radio) {
            radio.addEventListener('change', function() {
                var obj = {};
                obj[this.name] = this.value;
                queueAutosave(obj);
                if (formAttempted) {
                    var itemNumber = this.name.replace('item', '');
                    var questionDiv = document.getElementById('question-' + itemNumber);
                    if (questionDiv) {
                        questionDiv.classList.remove('unanswered');
                        questionDiv.classList.remove('scroll-highlight');
                    }
                }
            });
        });
        
        form.addEventListener('submit', function(e) {
            formAttempted = true;
            if (!validateForm()) {
                e.preventDefault();
                var ageInput = document.getElementById('age');
                var genderSelect = document.getElementById('gender');
                
                if (!ageInput.value) ageInput.classList.add('invalid'); else ageInput.classList.remove('invalid');
                if (!genderSelect.value) genderSelect.classList.add('invalid'); else genderSelect.classList.remove('invalid');
                
                for (var i = 1; i <= 24; i++) {
                    var checked = form.querySelector('input[name="item' + i + '"]:checked');
                    var questionDiv = document.getElementById('question-' + i);
                    if (!checked && questionDiv) questionDiv.classList.add('unanswered');
                    else if (questionDiv) questionDiv.classList.remove('unanswered');
                }
                
                var firstInvalidDemo = document.querySelector('#age.invalid, #gender.invalid');
                var firstUnanswered = document.querySelector('.question-item.unanswered');
                if (firstInvalidDemo) firstInvalidDemo.scrollIntoView({ behavior: 'smooth', block: 'center' });
                else if (firstUnanswered) firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                return false;
            }
        });
        
        var ageInput = document.getElementById('age');
        var genderSelect = document.getElementById('gender');
        if (ageInput) {
            ageInput.addEventListener('input', function() {
                queueAutosave({ age: this.value });
                if (formAttempted && this.value) this.classList.remove('invalid');
            });
        }
        if (genderSelect) {
            genderSelect.addEventListener('change', function() {
                queueAutosave({ gender: this.value });
                if (formAttempted && this.value) this.classList.remove('invalid');
            });
        }

        function queueAutosave(partialData) {
            pendingAutosave = Object.assign(pendingAutosave, partialData);
            if (autosaveTimer) clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(function() {
                var payload = Object.assign({}, pendingAutosave);
                pendingAutosave = {};
                doAutosave(payload);
            }, 400);
        }

        async function doAutosave(payload) {
            if (!responseIdInput || !sesskeyInput || !courseIdInput) return;
            var params = new URLSearchParams();
            params.set('ajax', '1');
            params.set('auto_save', '1');
            params.set('cid', courseIdInput.value);
            params.set('responseid', responseIdInput.value);
            params.set('sesskey', sesskeyInput.value);
            Object.keys(payload).forEach(function(key) {
                if (payload[key] !== undefined && payload[key] !== null) params.set(key, payload[key]);
            });
            try {
                await fetch(form.action, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: params.toString(), credentials: 'same-origin' });
            } catch (e) {}
        }
    }
    
    function validateForm() {
        var isValid = true;
        var age = document.getElementById('age');
        var gender = document.getElementById('gender');
        if (!age.value) isValid = false;
        if (!gender.value) isValid = false;
        for (var i = 1; i <= 24; i++) {
            var checked = form.querySelector('input[name="item' + i + '"]:checked');
            if (!checked) isValid = false;
        }
        return isValid;
    }

    // Scroll to first unanswered or finish button on load
    setTimeout(function() {
        var urlParams = new URLSearchParams(window.location.search);
        
        // 1. Scroll to Finish if requested
        if (urlParams.get('scroll_to_finish')) {
             var container = document.getElementById('finishButtonContainer');
             if (container) {
                 container.classList.add('scroll-highlight');
                 container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 setTimeout(function() { container.classList.remove('scroll-highlight'); }, 3000);
             }
        } 
        else {
            // 2. Resume logic: find first unanswered field (Age, Gender, or Questions)
            var firstUnanswered = null;
            
            // Check if user has started answering at all (at least one field filled or saved)
            var ageInput = document.getElementById('age');
            var genderSelect = document.getElementById('gender');
            var hasProgress = (ageInput && ageInput.value) || (genderSelect && genderSelect.value) || document.querySelector('input[type="radio"]:checked');

            if (hasProgress) {
                // Check Age
                if (ageInput && !ageInput.value) {
                    firstUnanswered = ageInput.closest('.form-group') || ageInput;
                }
                // Check Gender
                else if (genderSelect && !genderSelect.value) {
                    firstUnanswered = genderSelect.closest('.form-group') || genderSelect;
                }
                // Check Questions
                else {
                    var questionItems = document.querySelectorAll('.question-item');
                    for (var i = 0; i < questionItems.length; i++) {
                        var item = questionItems[i];
                        // Find any checked radio within this item
                        if (!item.querySelector('input[type="radio"]:checked')) {
                            firstUnanswered = item;
                            break;
                        }
                    }
                }
            }

            if (firstUnanswered) {
                firstUnanswered.classList.add('scroll-highlight');
                firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(function() { firstUnanswered.classList.remove('scroll-highlight'); }, 3000);
            }
        }
    }, 500);
});
{{/js}}
