<div class="block_tmms_24_container">
    <h1 class="mb-4 text-center">
        {{{icon_html}}} {{title}}
    </h1>

    <div class="alert alert-info mb-4">
        {{{description}}}
    </div>

    {{#delete_confirmation}}
    <div class="alert alert-warning">
        <h4>{{#str}}delete_response, block_tmms_24{{/str}}</h4>
        <p>{{confirm_message}}</p>
        <div class="mt-3">
            <a href="{{confirm_url}}" class="btn btn-danger">{{#str}}delete{{/str}}</a>
            <a href="{{cancel_url}}" class="btn btn-secondary text-white">{{#str}}cancel{{/str}}</a>
        </div>
    </div>
    {{/delete_confirmation}}

    {{^delete_confirmation}}
    <!-- Statistics cards -->
    <div class="row mb-4">
        <!-- Enrolled -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card" style="border-color: #f60 !important;">
                <div class="card-body text-center">
                    <i class="fa fa-users text-primary" style="font-size: 2em; margin-bottom: 10px;"></i>
                    <h5 class="card-title">{{#str}}enrolled_students, block_tmms_24{{/str}}</h5>
                    <h2 class="text-primary">{{total_enrolled}}</h2>
                </div>
            </div>
        </div>
        <!-- Completed -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="fa fa-check-circle text-success" style="font-size: 2em; margin-bottom: 10px;"></i>
                    <h5 class="card-title">{{#str}}total_completed, block_tmms_24{{/str}}</h5>
                    <h2 class="text-success">{{total_completed}}</h2>
                </div>
            </div>
        </div>
        <!-- In Progress -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="fa fa-hourglass-half text-warning" style="font-size: 2em; margin-bottom: 10px;"></i>
                    <h5 class="card-title">{{#str}}in_progress, block_tmms_24{{/str}}</h5>
                    <h2 class="text-warning">{{total_in_progress}}</h2>
                </div>
            </div>
        </div>
        <!-- Rate -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card" style="border-color: #f60 !important;">
                <div class="card-body text-center">
                    <i class="fa fa-percent text-primary" style="font-size: 2em; margin-bottom: 10px;"></i>
                    <h5 class="card-title">{{#str}}completion_rate, block_tmms_24{{/str}}</h5>
                    <h2 class="text-primary">{{completion_rate}}%</h2>
                </div>
            </div>
        </div>
    </div>

    {{#has_completed}}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-chart-bar"></i> {{#str}}dimension_statistics, block_tmms_24{{/str}}</h5>
                </div>
                <div class="card-body" id="tmms-stats-ajax-wrapper" data-filter="{{gender_filter}}">
                    
                    <!-- Filter Buttons -->
                    <div class="d-flex justify-content-end align-items-center mb-3">
                        <span class="mr-2 font-weight-bold">{{#str}}filter_by_gender, block_tmms_24{{/str}}: </span>
                        <div class="btn-group" role="group">
                            <a href="{{url_all}}" class="btn btn-sm tmms-filter-btn" style="{{style_all}}">{{#str}}all, block_tmms_24{{/str}}</a>
                            <a href="{{url_m}}" class="btn btn-sm tmms-filter-btn" style="{{style_m}}">{{#str}}gender_male, block_tmms_24{{/str}}</a>
                            <a href="{{url_f}}" class="btn btn-sm tmms-filter-btn" style="{{style_f}}">{{#str}}gender_female, block_tmms_24{{/str}}</a>
                        </div>
                    </div>

                    {{#is_filter_all}}
                    <div class="alert alert-warning py-2 mb-3 small"><i class="fa fa-exclamation-triangle"></i> {{#str}}gender_filter_warning, block_tmms_24{{/str}}</div>
                    {{/is_filter_all}}

                    <div class="row">
                        {{#dimension_stats}}
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tmms-dimension-avg-card h-100 shadow-sm" style="cursor: pointer; transition: all 0.3s; border-radius: 15px;" onclick="showRanges('{{dim_key}}')">
                                <div class="card-body d-flex flex-column p-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="font-weight-bold mb-0" style="color: #444;">{{dim_name}}</h5>
                                    </div>
                                    
                                    {{#is_filter_active}}
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-end mb-1">
                                            <span class="text-muted small">{{#str}}average_score, block_tmms_24{{/str}}</span>
                                            <h3 class="mb-0 font-weight-bold" style="color: #333;">{{avg_score}}<span class="text-muted" style="font-size: 0.5em; font-weight: normal;">/40</span></h3>
                                        </div>
                                        <div class="progress" style="height: 12px; border-radius: 6px; background-color: #e9ecef;">
                                            <div class="progress-bar" role="progressbar" style="width: {{progress_width}}%; {{{bar_gradient_css}}} border-radius: 6px; transition: width 1s ease-in-out;" aria-valuenow="{{avg_score}}" aria-valuemin="0" aria-valuemax="40"></div>
                                        </div>
                                    </div>
                                    {{/is_filter_active}}
                                    {{^is_filter_active}}
                                    <div class="text-center mb-4 py-3" style="background-color: #f8f9fa; border-radius: 10px; border: 1px dashed #dee2e6;">
                                        <i class="fa fa-lock text-muted mb-2" style="font-size: 1.5em; opacity: 0.5;"></i>
                                        <div class="small text-muted">{{#str}}select_gender_for_avg, block_tmms_24{{/str}}</div>
                                    </div>
                                    {{/is_filter_active}}

                                    <div class="mt-auto">
                                        <div class="row text-center">
                                            {{#distributions}}
                                            <div class="col-4 px-1">
                                                <div class="mb-1"><i class="fa {{icon}}" style="color: {{color}}; font-size: 1.2em;"></i></div>
                                                <div class="font-weight-bold" style="font-size: 1.1em; color: #333;">{{count}}</div>
                                                <div class="text-muted" style="font-size: 0.65em; text-transform: uppercase; letter-spacing: 0.5px;">{{label}}</div>
                                            </div>
                                            {{/distributions}}
                                        </div>
                                        <div class="text-center mt-3 pt-3 border-top">
                                            <small class="text-primary font-weight-bold" style="cursor: pointer;"><i class="fa fa-eye"></i> {{#str}}click_to_view_ranges, block_tmms_24{{/str}}</small>
                                        </div>
                                    </div>
                                    
                                    <div id="mobile-ranges-{{dim_key}}" class="d-md-none mt-3" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                        {{/dimension_stats}}
                    </div>
                    
                    <div id="desktop-ranges-container" class="d-none d-md-block mt-4"></div>
                </div>
            </div>
        </div>
    </div>
    {{/has_completed}}
    
    <div id="tmms-24-results-region">
        {{#show_table}}
        <div class="card mt-5">
            <div class="card-header">
                <h5 class="mb-0">{{#str}}student_responses, block_tmms_24{{/str}}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3 w-100 mx-0">
                    <div class="col-md-9 pl-0 pr-0 pr-md-2">
                        <form id="searchForm" onsubmit="return false;" style="width: 100%;">
                            <div class="input-group" style="width: 100%;">
                                <input type="text" id="searchInput" class="form-control" placeholder="{{#str}}search_student, block_tmms_24{{/str}}" value="{{search_term}}" autocomplete="off">
                            </div>
                        </form>
                    </div>
                    <div class="col-md-3 text-end d-flex justify-content-center justify-content-md-end mt-3 mt-md-0 pr-0 pl-0 pl-md-2">
                        <div class="btn-group w-100">
                            <a href="{{download_csv_url}}" class="btn btn-success"><i class="fa fa-download mr-2"></i> {{#str}}download_csv, block_tmms_24{{/str}}</a>
                            <a href="{{download_json_url}}" class="btn btn-primary"><i class="fa fa-file-code-o mr-2"></i> {{#str}}download_json, block_tmms_24{{/str}}</a>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>{{#str}}student, block_tmms_24{{/str}}</th>
                                <th>{{#str}}email{{/str}}</th>
                                <th>{{#str}}status, block_tmms_24{{/str}}</th>
                                <th>{{#str}}perception, block_tmms_24{{/str}}</th>
                                <th>{{#str}}comprehension, block_tmms_24{{/str}}</th>
                                <th>{{#str}}regulation, block_tmms_24{{/str}}</th>
                                <th>{{#str}}date_last_action, block_tmms_24{{/str}}</th>
                                <th>{{#str}}actions, block_tmms_24{{/str}}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#participants}}
                            <tr>
                                <td>{{{user_picture}}} <span class="ms-2"><strong>{{fullname}}</strong></span></td>
                                <td>{{email}}</td>
                                <td>
                                    {{#is_completed}}
                                    <span class='badge bg-success text-white'><i class='fa fa-check'></i> {{#str}}completed, block_tmms_24{{/str}}</span>
                                    {{/is_completed}}
                                    {{^is_completed}}
                                    <span class='badge bg-warning text-dark'><i class='fa fa-hourglass-half'></i> {{#str}}in_progress, block_tmms_24{{/str}}</span>
                                    <br><small class='text-muted'>{{answered_count}}/24 {{#str}}questions, block_tmms_24{{/str}}</small>
                                    {{/is_completed}}
                                </td>
                                <td>{{{perception_cell}}}</td>
                                <td>{{{comprehension_cell}}}</td>
                                <td>{{{regulation_cell}}}</td>
                                <td>{{date_cell}}</td>
                                <td>
                                    <a href="{{view_results_url}}" class="btn btn-sm tmms-view-results mr-2 mt-1 mb-1" title="{{#str}}view_results, block_tmms_24{{/str}}"><i class="fa fa-eye"></i> {{#str}}view_results, block_tmms_24{{/str}}</a>
                                    {{#can_delete}}
                                    <a href="{{delete_url}}" class="btn btn-sm btn-danger mr-2 mt-1 mb-1" title="{{#str}}delete{{/str}}"><i class="fa fa-trash"></i> {{#str}}delete{{/str}}</a>
                                    {{/can_delete}}
                                </td>
                            </tr>
                            {{/participants}}
                            {{^participants}}
                            <tr>
                                <td colspan="8" class="text-center p-4">
                                    <div class="alert alert-warning mb-0">
                                        <i class="fa fa-exclamation-triangle mr-2"></i> {{#str}}no_results_search, block_tmms_24, {{search_term}}{{/str}}
                                    </div>
                                </td>
                            </tr>
                            {{/participants}}
                        </tbody>
                    </table>
                </div>
                
                {{#has_participants}}
                <div class="mt-3 d-flex justify-content-center">
                    {{{pagination}}}
                </div>
                {{/has_participants}}
            </div>
        </div>
        {{/show_table}}
        {{^show_table}}
        <div class="alert alert-info mt-4">
            <i class="fa fa-info-circle"></i> 
            <h5>{{#str}}no_results_yet, block_tmms_24{{/str}}</h5>
            <p>{{#str}}no_participants_message, block_tmms_24{{/str}}</p>
        </div>
        {{/show_table}}
    </div>
    
    {{/delete_confirmation}}

    <div class="mt-4 text-center">
        <a href="{{back_url}}" class="btn btn-secondary">
            <i class="fa fa-arrow-left"></i> {{#str}}back_to_course, block_tmms_24{{/str}}
        </a>
    </div>

</div>

{{#js}}
require(['jquery'], function($) {
    var container = $('#tmms-24-results-region');
    var statsWrapper = $('#tmms-stats-ajax-wrapper');
    var rangeData = {{{ranges_json}}};
    var strGender = '{{#str}}gender, block_tmms_24{{/str}}';
    var strMale = '{{#str}}male, block_tmms_24{{/str}}';
    var strFemale = '{{#str}}gender_female, block_tmms_24{{/str}}';
    var currentFilter = '{{gender_filter}}';

    // 1. Search & Pagination
    var timeout = null;
    
    container.on('input', '#searchInput', function() {
        var input = $(this);
        if (timeout) clearTimeout(timeout);
        var searchTerm = input.val();
        
        timeout = setTimeout(function() {
            loadResults(searchTerm, 0); 
        }, 300);
    });
    
    container.on('click', '.pagination a', function(e) {
        e.preventDefault();
        var href = $(this).attr('href');
        if (!href) return;
        
        var urlParams = new URLSearchParams(href.split('?')[1]);
        var page = urlParams.get('page') || 0;
        var searchTerm = container.find('#searchInput').val() || '';
        
        loadResults(searchTerm, page);
    });

    function loadResults(search, page) {
        var url = '{{page_url}}';
        var data = {
            courseid: {{courseid}},
            search: search,
            page: page,
            action: 'list' 
        };
        
        container.closest('.block_tmms_24_container').css('opacity', '0.6');
        
        $.get(url, data, function(response) {
            var responseObj = $('<div>').html(response);
            var newContent = responseObj.find('#tmms-24-results-region').html();
            
            if (newContent) {
                container.html(newContent);
                var input = container.find('#searchInput');
                if (input.length) {
                    input.focus();
                    var tmpStr = input.val();
                    input.val('');
                    input.val(tmpStr);
                }
            }
            container.closest('.block_tmms_24_container').css('opacity', '1');
        });
    }

    // 2. Gender Filter
    $(document).on('click', '.tmms-filter-btn', function(e) {
        e.preventDefault();
        var url = $(this).attr('href');
        
        if (statsWrapper.length) {
            statsWrapper.css('opacity', '0.5');
            statsWrapper.css('pointer-events', 'none');
            
            $.get(url, function(response) {
                var responseObj = $('<div>').html(response);
                var newContent = responseObj.find('#tmms-stats-ajax-wrapper').html();
                var newFilter = responseObj.find('#tmms-stats-ajax-wrapper').attr('data-filter');
                
                if (newContent) {
                    statsWrapper.html(newContent);
                    statsWrapper.attr('data-filter', newFilter);
                    currentFilter = newFilter;
                }
                statsWrapper.css('opacity', '1');
                statsWrapper.css('pointer-events', 'auto');
            });
        }
    });

    // 3. Show Ranges
    window.showRanges = function(dimKey) {
        var data = rangeData[dimKey];
        if (!data) return;

        var html = '<div class="card bg-light border-0 shadow-none"><div class="card-body p-3">';
        html += '<h6 class="card-title text-center mb-3">' + data.title + ' - {{#str}}reference_ranges, block_tmms_24{{/str}}</h6>';
        html += '<div class="table-responsive"><table class="table table-sm table-bordered text-center small bg-white mb-0">';
        html += '<thead class="thead-light"><tr>';
        html += '<th>' + strGender + '</th>';
        data.headers.forEach(function(h) { html += '<th>' + h + '</th>'; });
        html += '</tr></thead><tbody>';

        var showM = (currentFilter === 'all' || currentFilter === 'M');
        var showF = (currentFilter === 'all' || currentFilter === 'F');

        if (showM) {
            html += '<tr><td>' + strMale + '</td>';
            data.rows.M.forEach(function(val) { html += '<td>' + val + '</td>'; });
            html += '</tr>';
        }
        if (showF) {
            html += '<tr><td>' + strFemale + '</td>';
            data.rows.F.forEach(function(val) { html += '<td>' + val + '</td>'; });
            html += '</tr>';
        }

        html += '</tbody></table></div></div></div>';

        // Mobile
        var mobileContainer = document.getElementById('mobile-ranges-' + dimKey);
        if (mobileContainer) {
            $('[id^="mobile-ranges-"]').hide();
            if ($(mobileContainer).is(':visible')) {
                $(mobileContainer).hide();
            } else {
                $(mobileContainer).html(html).show();
            }
        }

        // Desktop
        var desktopContainer = document.getElementById('desktop-ranges-container');
        if (desktopContainer) {
            var currentDim = $(desktopContainer).attr('data-active-dim');
            if (currentDim === dimKey && $(desktopContainer).is(':visible')) {
                 $(desktopContainer).hide();
                 $(desktopContainer).removeAttr('data-active-dim');
                 $(desktopContainer).html('');
            } else {
                 $(desktopContainer).html(html).show();
                 $(desktopContainer).attr('data-active-dim', dimKey);
            }
        }
    };
});
{{/js}}
